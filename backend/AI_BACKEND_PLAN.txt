IDRISIUM IDEAS FORGE – AI Backend Plan (Vercel / FastAPI / Gemini 2.5 Pro)

1) Core AI Features (Gemini Orchestrator)
- Difficulty Estimator (المقدر الذكي)
  - Endpoint: POST /ai/analyze-difficulty
  - Model: Gemini 2.5 Pro via GeminiManager.analyze_difficulty
  - Output: level ∈ {Easy, Medium, Impossible}, reason.

- Title Fixer (مصحح العناوين)
  - Endpoint: POST /ai/fix-title
  - Input: bad_title, description
  - Logic: AI يقترح عنوان محسّن بدون تغيير الفكرة نفسها.
  - Integration with ideas:
    - /submit_idea يستدعي fix_title لكن يخزن:
      - title = cleaned_title (للعرض)
      - raw_title = عنوان المستخدم الأصلي (للحفاظ على فكرته).

- Duplicate Detector (كاشف التكرار)
  - Low-level Endpoint: POST /ai/detect-duplicate (TF-IDF/SequenceMatcher بين نص جديد وقائمة مرشحين)
  - High-level Flow (to add):
    - عند /submit_idea:
      1) جلب أفكار مرشحة من Firestore (نفس اللغة / نفس التاجات تقريباً).
      2) نمررها إلى GeminiManager.detect_duplicate.
      3) لو is_duplicate=True نرجع رسالة واضحة للفرونت: الفكرة موجودة، روح صوّت بدل ما تكتبها تاني.

- Auto Tagging (المصنف الآلي)
  - Endpoint: POST /ai/auto-tagger
  - Allowed tags: Productivity, Game, Utility, Health, Dark Web, Islamic
  - استخدم في /submit_idea لتخزين tags في الدوكيومنت.

- Roast My Idea (Roast Mode)
  - Endpoint: POST /ai/roast
  - Output: roast string (للمرح والضحك بدون إساءة لفئات محمية).

- Success Prediction (توقع النجاح)
  - Endpoint: POST /ai/success-prediction
  - Output: success_rate (0-100), explanation.

- Debate Mode (مناظرة الأفكار)
  - Endpoint: POST /ai/debate
  - Input: فكرتين + IDs
  - Output: transcript حوار بين شخصيتين (مثلاً Steve Jobs & Elon Musk).

- Idea Evolution (تطوير الفكرة – V2.0 Roadmap)
  - Endpoint: POST /ai/evolution
  - Output: evolution (markdown roadmap للنسخة 2.0).


2) Gemini Keys Management (Multiple API Keys / Load Balancing)
- Implementation: GeminiManager (ai_engine.py)
  - Rotating over api_keys مع حالة لكل مفتاح (cooldown عند 429/500/503).
  - Supports concurrent calls in Vercel/FastAPI context.

- Configuration Sources:
  - Firestore: collection config, document ai_settings.gemini_api_keys
  - Fallback: GEMINI_API_KEYS env (comma-separated)

- Admin Endpoint:
  - POST /admin/gemini-keys
    - Input: { keys: ["key1", "key2", ...] }
    - Access: Admin only via Firebase token + ADMIN_EMAIL.


3) Moderation & Abuse Protection
- Context Aware Filter (فلتر الشتيمة الذكي)
  - Helper: context_aware_filter_text(manager, text)
  - Features:
    - Strip HTML.
    - Hard block على BANNED_WORDS (EN + AR), مع تحسين لاحق للكشف عن الأحرف المقطّعة (إزالة المسافات/الرموز ثم الفحص).
    - Gemini toxicity scoring (0–1) مع threshold 0.8.
  - API:
    - POST /moderation/filter → ModerationResponse
  - Integration:
    - /submit_idea: رفض الفكرة لو moderation.allowed=False مع رسالة detail.

- Spam Guard (كاشف السبام / Ban مؤقت)
  - Model: SpamGuardRequest/Response
  - Endpoint: POST /moderation/spam-guard
  - Logic:
    - قراءة آخر الأفكار للمستخدم من Firestore (ideas where author_uid = user_id ordered by created_at DESC limit N).
    - N = SPAM_MAX_PER_MINUTE (افتراضي 5).
    - لو كلهم خلال آخر 60 ثانية → Ban 10 دقائق (تخزين spam_state.banned_until_ts في user document).


4) Ideas Lifecycle & Core Endpoints
- Submit Idea (إنشاء فكرة)
  - Endpoint: POST /submit_idea
  - Input: SubmitIdeaRequest(title, description, author_uid, optional author_name)
  - Steps:
    1) Moderation: context_aware_filter_text.
    2) Title Fix: GeminiManager.fix_title (مع الحفاظ على raw_title).
    3) Difficulty: analyze_difficulty (مع mapping Impossible → Hard للعرض، مع الاحتفاظ بـ difficulty_raw).
    4) Auto Tagging.
    5) (To add) Duplicate check عبر detect_duplicate + Firestore.
    6) تخزين في Firestore collection ideas مع الحقول:
       - title, raw_title, description, author, uid, author_uid, votes, difficulty, difficulty_raw, difficulty_reason, tags, is_deleted, timestamps.

- Admin Controls for Submissions
  - POST /admin/submissions/open → config/system_settings.are_submissions_open = True
  - POST /admin/submissions/close → ... = False
  - Cron Auto Lock:
    - POST /cron/auto-lock
    - Logic: الساعة 00:00 بتوقيت Cairo (tz من CAIRO_TZ env) → are_submissions_open=False.

- Surprise Me (زرار العشوائية)
  - Public Endpoint to add:
    - GET /ideas/random → random idea (id + title + maybe snippet of description).
  - Admin already has /admin/random-idea (سنُبقيه ونضيف نسخة عامة بدون صلاحيات Admin).


5) Reputation System & Ranking
- Goal: أفكار أصحاب السمعة الأعلى تظهر أولاً.
- Firestore data model (to use/extend):
  - collection users: لكل user
    - fields نضيفها:
      - reputation_score (float/int)
      - ideas_count, votes_given, votes_received
      - badges: ["Thinker", "Co-Founder"]
  - collection ideas:
    - author_uid, votes, created_at, status (proposed/approved/implemented).

- Backend responsibilities (to add):
  - Endpoint: GET /analytics/user-ranking
    - Returns: top users by activity (ideas_count + votes_given + votes_received weighted).
  - Helper functions:
    - update_user_reputation_on_new_idea(user_id)
    - update_user_reputation_on_vote(user_id, idea_author_id)
    - update_user_reputation_on_idea_implemented(user_id)

- Ideas Listing with Reputation Ordering (optional API):
  - Endpoint to add: GET /ideas/recommended
    - Combines vote count, recency, and author reputation to sort.


6) Voting, Trending, Heatmap, News Ticker
- Data model (to extend, if frontend uses backend for votes):
  - collection ideas/{ideaId}/votes subcollection
    - { user_id, user_name, user_email, created_at }

- Endpoints to add:
  - POST /ideas/{idea_id}/vote
    - Validates spam/limits per user (optionally reusing spam-guard).
    - Writes vote doc + increments ideas.votes counter.

  - GET /analytics/trending
    - Logic: ideas with highest number of votes in آخر ساعة (based on votes subcollection timestamps).

  - GET /analytics/voting-heatmap
    - Aggregates vote timestamps → (day, hour, count) buckets.

  - GET /analytics/recent-votes (شريط الأخبار)
    - Returns last N votes (user_name, idea_title, timestamp).


7) Analytics & Growth
- Existing:
  - POST /analytics/heatmap: يحوّل timestamps → buckets (day, hour, count).
  - POST /analytics/wordcloud: generate_wordcloud_tokens(texts) → WordCloudResponse.
  - GET /stats: total ideas + wordcloud over descriptions.

- To add:
  - GET /analytics/growth
    - Output: per-day counts of ideas (date, count) لبناء الرسم البياني "عداد النمو".

  - Word Cloud (سحابة الكلمات)
    - Already implemented via generate_wordcloud_tokens + /analytics/wordcloud + /stats.


8) Badges & User Ranking
- Badges:
  - "مفكر" (Thinker): user كتب ≥ 5 أفكار.
  - "شريك مؤسس" (Co-Founder): عند تنفيذ فكرته (status=implemented).

- Backend logic (to add):
  - Helper: ensure_badges(user_doc)
  - Triggers:
    - On new idea: check ideas_count ≥ 5 → add "Thinker".
    - On idea implemented: add "Co-Founder" badge to author.

- User Ranking API (see section 5):
  - GET /analytics/user-ranking → returns list of users with stats + badges.


9) Notifications & Emails
- Infrastructure:
  - Use httpx.AsyncClient to call external Email provider via env EMAIL_WEBHOOK_URL (or similar), to keep provider configurable.

- Events:
  - Welcome Email (رسالة ترحيب)
    - Endpoint to add: POST /events/user-registered
      - Input: { uid, email, display_name }
      - Backend sends hacker-style welcome + site policies.

  - Idea Approved (إشعار لصاحب الفكرة)
    - Endpoint to add: POST /admin/ideas/{idea_id}/approve
      - Marks idea.status = "approved".
      - Fetches author email (from users collection) and sends congratulation email.

  - Idea Implemented (تنبيه "تم التنفيذ")
    - Endpoint to add: POST /admin/ideas/{idea_id}/implemented
      - Sets idea.status = "implemented".
      - Fetches all voters (votes subcollection) and sends broadcast email with app link.


10) Admin Dashboard APIs
- Authentication:
  - All admin endpoints behind get_admin_user (Firebase token + ADMIN_EMAIL env).

- Existing admin endpoints:
  - POST /admin/gemini-keys
  - POST /admin/submissions/open
  - POST /admin/submissions/close
  - POST /admin/random-idea

- To add for Admin Dashboard:
  - GET /admin/ideas/deleted
    - Returns soft-deleted ideas (is_deleted=True).

  - POST /admin/ideas/{idea_id}/delete
    - Soft-delete: sets is_deleted=True.

  - GET /admin/export (تصدير لـ CSV/Excel)
    - Returns CSV of all ideas (id, title, description, author, votes, tags, status, timestamps...).


11) Easter Eggs
- Behavior:
  - عند وجود كود سري في العنوان أو الوصف (مثل "IDRIS" أو اسمك الكامل):
    - الـ backend يرجع easter_egg: true في response.
  - Frontend يستخدمه لتشغيل أنيميشن خاصة.

- Implementation (to add):
  - Helper: detect_easter_egg(text) → bool
  - Integration in /submit_idea response: add field easter_egg: bool.


12) Sitemap Generator (SEO)
- Endpoint to add: GET /sitemap.xml
  - Reads ideas (is_deleted=False) from Firestore.
  - Uses SITE_BASE_URL env (e.g., https://idrisium.linkpc.net/ideas/{id}).
  - Generates standard XML sitemap string.


13) Security & Deployment
- Framework: FastAPI on Vercel (ASGI) via api/index.py
- Auth:
  - Firebase ID tokens for normal users.
  - ADMIN_EMAIL env for admin validation.
- Data:
  - Firestore (google-cloud-firestore) عبر firebase_client.get_firestore_client().
- Env vars (min):
  - FIREBASE_CREDENTIALS
  - GEMINI_API_KEYS or Firestore config/ai_settings.gemini_api_keys
  - ADMIN_EMAIL
  - SPAM_MAX_PER_MINUTE (optional)
  - CAIRO_TZ (optional, default Africa/Cairo)
  - SITE_BASE_URL (for sitemap and email links)
  - EMAIL_WEBHOOK_URL or equivalent (for notifications)


Next Steps (Implementation Order)
1) تأكيد واستغلال الـ AI endpoints الموجودة (analyze-difficulty, fix-title, detect-duplicate, auto-tagger, roast, success-prediction, debate, evolution, moderation, spam-guard).
2) توسيع /submit_idea ليشمل: duplicate check, easter_egg flag, وربط أقوى مع Reputation/Badges.
3) إضافة Endpoints جديدة:
   - /ideas/random (public)
   - /ideas/{idea_id}/vote
   - /analytics/trending, /analytics/voting-heatmap, /analytics/growth, /analytics/user-ranking, /analytics/recent-votes
   - /events/user-registered
   - /admin/ideas/{id}/approve, /admin/ideas/{id}/implemented, /admin/ideas/{id}/delete, /admin/ideas/deleted, /admin/export
   - /sitemap.xml
4) إنشاء Helpers للسمعة، البادجز، والإيميلات داخل backend.
5) ربط الفرونت بهذه الـ APIs وتحديث أي استدعاءات مباشرة لـ Firestore (إن وُجدت) لاستخدام الباك-إند الوسيط.
